<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Planville AI Chatbot</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>

  <!-- üìå Sidebar FAQ -->
  <div class="faq-sidebar">
    <h2>Frequently Asked Questions</h2>
    <ul id="faq-list"></ul>
  </div>

  <!-- üí¨ Main Chatbot UI -->
  <div class="chatbot-container">
    <div class="chatbot-header">
      <img src="planville-logo.png" alt="Planville Logo" class="chatbot-logo"/>
      <h1>Chat with Planville AI</h1>
      <label class="switch">
        <input type="checkbox" id="modeToggle" />
        <span class="slider"></span>
      </label>
    </div>

    <div id="chatbot-log"></div>
    <div id="typing-bubble" class="chatbot-message bot-message typing-bubble" style="display:none">...</div>

    <form id="chatbot-form">
      <input type="text" id="chatbot-input" placeholder="Type your question..." autocomplete="off"/>
      <button type="submit">üí¨</button>
    </form>

    <div class="language-switcher">
      <label for="langSwitcher">üåê Language:</label>
      <select id="langSwitcher">
        <option value="de">üá©üá™ Deutsch</option>
        <option value="en">üá¨üáß English</option>
      </select>
    </div>
  </div>

  <!-- üìã CONFIGURATOR FORM (SIMPLE) -->
  <div id="configForm" class="config-form" style="display: none;">
    <h2>Produkt w√§hlen</h2>
    <select id="productSelect">
      <option value="">Bitte ausw√§hlen</option>
      <option value="PV-Anlage">PV-Anlage</option>
      <option value="Dachsanierung">Dachsanierung</option>
      <option value="W√§rmepumpe">W√§rmepumpe</option>
      <option value="Klimaanlage">Klimaanlage</option>
      <option value="Speicherl√∂sung">Speicherl√∂sung</option>
    </select>

    <h2>Kontaktdaten</h2>
    <input type="text" id="vorname" placeholder="Vorname" required />
    <input type="text" id="nachname" placeholder="Nachname" required />
    <input type="tel" id="telefon" placeholder="Telefonnummer" required />
    <button id="submitConfig" type="button">Absenden</button>
  </div>

  <!-- üéØ FORM WIZARD (DOUBLE CLICK MODE) -->
  <div class="form-wizard" id="form-wizard" style="display:none">
    <h2>Jetzt starten</h2>
    <label for="product-choice">Produkt w√§hlen:</label>
    <select id="product-choice">
      <option value="Photovoltaik">Photovoltaik</option>
      <option value="W√§rmepumpe">W√§rmepumpe</option>
      <option value="Klimaanlage">Klimaanlage</option>
      <option value="Dachsanierung">Dachsanierung</option>
    </select>

    <label for="fname">Vorname:</label>
    <input type="text" id="fname" required />

    <label for="lname">Nachname:</label>
    <input type="text" id="lname" required />

    <label for="phone">Telefonnummer:</label>
    <input type="tel" id="phone" required />

    <button onclick="submitLead()">Absenden</button>
  </div>

  <!-- üç™ Cookie Consent -->
  <div id="cookie-banner" class="cookie-popup">
    <p id="cookie-message">Diese Website verwendet Cookies, um Ihr Erlebnis zu verbessern.</p>
    <div class="cookie-buttons">
      <button onclick="acceptCookies()">Akzeptieren</button>
      <button onclick="rejectCookies()">Ablehnen</button>
      <button onclick="openSettings()">Einstellungen</button>
    </div>
  </div>

  <!-- ‚öôÔ∏è CONFIG harus dimuat LEBIH DULU -->
  <script src="config.js?v=5"></script>
  <!-- ‚öôÔ∏è Chatbot Logic (pakai CONFIG) -->
  <script src="chatbot.js?v=5"></script>

  <!-- üß† GA4 & Event Tracking + Cookie (tanpa duplicate init UI) -->
  <script>
    function enableGTM() {
      const script = document.createElement("script");
      script.src = "https://www.googletagmanager.com/gtag/js?id=G-YL8ECJ5V17";
      script.async = true;
      document.head.appendChild(script);

      window.dataLayer = window.dataLayer || [];
      function gtag(){ dataLayer.push(arguments); }
      window.gtag = gtag;
      gtag('js', new Date());
      gtag('config', 'G-YL8ECJ5V17');
    }

    function trackChatEvent(question, lang) {
      if (typeof gtag !== "undefined") {
        gtag('event', 'chat_message', {
          event_category: 'chatbot',
          event_label: question,
          language: lang
        });
      }
    }

    function trackFAQClick(text) {
      if (typeof gtag !== "undefined") {
        const selectedLang = document.getElementById("langSwitcher").value;
        gtag('event', 'faq_click', {
          event_category: 'faq',
          event_label: text,
          language: selectedLang
        });
      }
    }

    function trackConfigStart() {
      if (typeof gtag !== "undefined") {
        gtag('event', 'start_config_click', {
          event_category: 'konfigurator',
          event_label: 'Jetzt starten'
        });
      }
    }

    function trackConfigSubmit(product) {
      if (typeof gtag !== "undefined") {
        gtag('event', 'config_submit_success', {
          event_category: 'konfigurator',
          event_label: product
        });
      }
    }

    function acceptCookies() {
      localStorage.setItem("cookieConsent", "accepted");
      document.getElementById("cookie-banner").style.display = "none";
      enableGTM();
    }

    function rejectCookies() {
      localStorage.setItem("cookieConsent", "rejected");
      document.getElementById("cookie-banner").style.display = "none";
    }

    function openSettings() {
      alert("Einstellungsseite ist noch in Entwicklung.");
    }

    // HANYA cookie & tombol konfigurator; JANGAN duplicate chat init.
    window.addEventListener("load", () => {
      const consent = localStorage.getItem("cookieConsent");
      if (!consent) {
        document.getElementById("cookie-banner").style.display = "block";
      } else if (consent === "accepted") {
        enableGTM();
      }

      const startBtn = document.getElementById("startConfigBtn");
      if (startBtn) {
        startBtn.addEventListener("click", () => {
          document.getElementById("configForm").style.display = "block";
          startBtn.style.display = "none";
          trackConfigStart();
        });
        startBtn.addEventListener("dblclick", () => {
          document.getElementById("form-wizard").style.display = "block";
          startBtn.style.display = "none";
        });
      }

      const submitBtn = document.getElementById("submitConfig");
      if (submitBtn) {
        submitBtn.addEventListener("click", async () => {
          const product  = document.getElementById("productSelect").value;
          const vorname  = document.getElementById("vorname").value.trim();
          const nachname = document.getElementById("nachname").value.trim();
          const telefon  = document.getElementById("telefon").value.trim();

          if (!product || !vorname || !nachname || !telefon) {
            alert("Bitte alle Felder ausf√ºllen.");
            return;
          }

          const payload = { vorname, nachname, telefon, product };

          // ‚ö†Ô∏è Endpoint ini belum ada di backend => skip / sesuaikan kalau nanti ditambah
          // const res = await fetch(`${CONFIG.BASE_API_URL}/save-config`, { ... });

          alert("Danke! Wir haben Ihre Anfrage erhalten.");
          trackConfigSubmit(product);
          document.getElementById("configForm").reset();
          document.getElementById("configForm").style.display = "none";
        });
      }
    });

    // Tetap di sini (dipakai di wizard)
    function submitLead() {
      const leadData = {
        produkt: document.getElementById("product-choice").value,
        vorname: document.getElementById("fname").value,
        nachname: document.getElementById("lname").value,
        telefon: document.getElementById("phone").value,
      };

      // ‚ö†Ô∏è Disabled: contoh Google Apps Script (isi kalau sudah ada)
      // const sheetURL = "https://script.google.com/macros/s/YOUR-SCRIPT-ID/exec";
      // fetch(sheetURL, { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(leadData) })

      alert("Vielen Dank! Wir melden uns bald.");
      if (typeof gtag !== "undefined") {
        gtag('event', 'wizard_submit', { event_category: 'leadform', event_label: leadData.produkt });
      }
      document.getElementById("form-wizard").style.display = "none";
      const startBtn = document.getElementById("startConfigBtn");
      if (startBtn) startBtn.style.display = "block";
    }
  </script>

</body>
</html>
